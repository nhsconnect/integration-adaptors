# EC2 Opentest Connection Setup Script

This is a [Fabric](https://www.fabfile.org/) script that can be used to
setup an existing EC2 instance to act as a proxy to Opentest.
Such an instance comprises of 3 parts:
- OpenVPN connection to Opentest
- Squid proxy to forward HTTP requests to Opentest Spine
- HAProxy proxy to:
  - pass inbound requests from Spine to MHS inbound
  - pass LDAP requests from MHS spine route lookup to SDS (Spine Directory Service)

# Usage

1. Create an EC2 instance running the Amazon Linux 2 AMI
1. `pipenv install`
1. Make sure that you have an ovpn file called `vpn-config.conf` in this
 folder. This should be the `.ovpn` file provided to you when your received
 your OpenTest credentials, renamed.
1. Make sure that `openvpn-up.sh` and `openvpn-down.sh` have Linux-style
 line endings, not Windows-style, otherwise the VPN connection won't get
  setup properly.
    1. You can accomplish this by running the command `dos2unix` on these files
1. `pipenv run fab -i ssh_key_file -H user@address --echo
 setup-ec2-openvpn setup-squid setup-haproxy
  --mhs-inbound-load-balancer-url=mhs-inbound-load-balancer-hostname-here`
    1. Where `ssh_key_file` is the `.pem` private key file for the EC2
     instance to configure
    1. Where `address` is the publicly-accessible DNS name or IP address of the
     EC2 instance to configure
    1. Where the MHS inbound load balancer hostname is the one output from the MHS
    terraform scripts (e.g. `mhs-inbound.environment-name.dns.suffix`)
    1. Note that `user` must have sudo access (note that on AWS,
   `ec2-user` is a default user with sudo access).
    1. This script should be fairly safe to run multiple times. 

There is a Fabric command `setup-ec2-openvpn-for-ecs-container` that can
be used for setting up an OpenVPN connection on an ECS EC2 instance.
This was used previously when running MHS on a single EC2 instance.
