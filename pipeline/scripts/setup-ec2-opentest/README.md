# EC2 Opentest Connection Setup Script

This is a [Fabric](https://www.fabfile.org/) script that can be used to
setup an EC2 instance to act as a proxy to Opentest.
Such an instance comprises of 3 parts:
- OpenVPN connection to Opentest
- Squid proxy to forward HTTP requests to Opentest Spine
- HAProxy proxy to:
  - pass inbound requests from Spine to MHS inbound
  - pass LDAP requests from MHS spine route lookup to SDS (Spine Directory Service)

# Usage

- `pipenv install`
- Make sure that you have an ovpn file called `vpn-config.conf` in this
 folder.
- Make sure that `openvpn-up.sh` and `openvpn-down.sh` have Linux-style
 line endings, not Windows-style, otherwise the VPN connection won't get
  setup properly.
- `pipenv run fab -i ssh_key_file -H user@address --echo
 setup-ec2-openvpn setup-squid setup-haproxy
  --mhs-inbound-load-balancer-url=mhs-inbound-load-balancer-url-here`
  - Note that `user` must have sudo access (note that on AWS,
   `ec2-user` is a default user with sudo access).
  - This script should be fairly safe to run multiple times.

There is a Fabric command `setup-ec2-openvpn-for-ecs-container` that can
be used for setting up an OpenVPN connection on an ECS EC2 instance.
This was used previously when running MHS on a single EC2 instance.
